<!--

Copyright (c) 2011 Shakir James and Washington University in St. Louis.
All rights reserved

 Redistribution and use in source and binary forms, with or without
 modification, are permitted provided that the following conditions
 are met:
   1. Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.
   2. Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
   3. The name of the author or Washington University may not be used 
      to endorse or promote products derived from this source code 
      without specific prior written permission.
   4. Conditions of any other entities that contributed to this are also
      met. If a copyright notice is present from another entity, it must
      be maintained in redistributions of the source code.

THIS INTELLECTUAL PROPERTY (WHICH MAY INCLUDE BUT IS NOT LIMITED TO SOFTWARE,
FIRMWARE, VHDL, etc) IS PROVIDED BY THE AUTHOR AND WASHINGTON UNIVERSITY 
``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED 
TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR 
PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR WASHINGTON UNIVERSITY 
BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
ARISING IN ANY WAY OUT OF THE USE OF THIS INTELLECTUAL PROPERTY, EVEN IF 
ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->
<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
            <style type="text/css">
            html { height: 100% }
            body { height: 100%; margin: 0; padding: 0; font-family: 'Arial'; font-size:80%; }
            #map_canvas { height: 100% }
            .info-content { min-width: 210px; min-height:210px;}
            .link-chart { min-width:200px; min-height:63px; background:url({{ STATIC_URL }}img/loader.gif) no-repeat 50% 20%;}
        </style>
        <script type="text/javascript"
            src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js">
        </script>    
        <script type="text/javascript"
            src="http://maps.googleapis.com/maps/api/js?v=3.7&key=AIzaSyDqM6bDLkXyXgK-8L6aFnYdHpuHK-lLfMk&sensor=false">
        </script>
        <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.timers.min.js"></script>        
        <script type="text/javascript" src="{{ STATIC_URL }}js/maplabel.min.js"></script>
        <!-- charts api -->
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">
          google.load("visualization", "1", {packages:["imagesparkline"]});
        </script>
        <script type="text/javascript">
            function initialize() {
                var stylesArray = [
                    {
                        featureType: "road",
                        stylers: [
                            { visibility: "off" }
                        ]
                    },{
                        featureType: "transit",
                        stylers: [
                            { visibility: "off" }
                        ]
                    },{
                        featureType: "poi",
                        stylers: [
                            { visibility: "off" }
                        ]
                    },{
                        featureType: "administrative",
                        stylers: [
                            { visibility: "simplified" }
                        ]
                    },{
                        featureType: "administrative",
                        elementType: "labels",
                        stylers: [
                            { visibility: "off" }
                        ]
                    }
                ]
            var us = new google.maps.LatLng(38.6,-96.6);
            var myOptions = {
                zoom: 5,
                center: us,
                mapTypeControl: false,
                scaleControl: false,
                streetViewControl: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map($("#map_canvas")[0], myOptions);
            map.setOptions({styles: stylesArray});
            var infowindow = new google.maps.InfoWindow();
            var linkColorInactive = "#666666";
            // title (use a marker because labels are not clickable)
            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(45, -96.6),
                map: map,
                title: '',
                icon: '{{ STATIC_URL }}img/ndn_testbed.png'
            });
            google.maps.event.addListener(marker, 'click', function() {
                window.open('http://www.cs.arizona.edu/people/yifengl/tbs.html','_blank')
            });

            // ec2 regions
            //$.getJSON('/json/ec2regions/', function(regions) {
            //    $(regions).each(function() {
            //        var region = this;
            //        lat = region.position[0];
            //        lng = region.position[1];
            //        var triangleCoords = [
            //           new google.maps.LatLng(lat+.5, lng-1),
            //           new google.maps.LatLng(lat+.5, lng+1),
            //           new google.maps.LatLng(lat-.8, lng), // bottom point
            //           new google.maps.LatLng(lat+.5, lng-1)
            //         ];
            //        var polygon = new google.maps.Polygon({
            //            paths: triangleCoords,
            //            strokeColor: "#E9BC14",
            //            strokeOpacity: 1,
            //            strokeWeight: 1,
            //            fillColor: "#E9BC14",
            //            fillOpacity: 0.5,
            //            map: map
            //        });
            //    });                                   
            //});
            
            // ndn routers
            $.getJSON("/json/geocode" , function(geocode) {
                var latLngList = [];            
                $.getJSON('/json/routers/', function(routers) {
                    $(routers).each(function() {
                        var router = geocode[this];
                        if (router.backbone == true) {
                            icon = '{{ STATIC_URL }}img/circle.png';
                        } 
                        else {
                            icon = '{{ STATIC_URL }}img/rectangle.png';                    
                        }
                        lat = router.position[0];
                        lng = router.position[1];
                        var marker = new google.maps.Marker({
                            position: new google.maps.LatLng(lat, lng),
                            map: map,
                            title: router.description,
                            icon: icon
                        });
                        var mapLabel = new MapLabel({
                            text: router.shortname,
                            position: new google.maps.LatLng(lat-.1, lng),
                            map: map,
                            fontSize: 13,
                            align: 'center',
                            minZoom: 4,
                        });
                        latLngList.push(new google.maps.LatLng(lat, lng))
                        var contentString = '<div class="info-content">'+
                                             '<h1>' + router.name + '</h1>' +
                                             '<p><a target="_blank" ' + 
                                             'href="'+ router.site +'">' +
                                             router.site + '</a></p>' +
                                             '</div>';
                        google.maps.event.addListener(marker, 'click', function() {
                            infowindow.setContent(contentString)
                            infowindow.open(map, marker);
                        });
                    });
                    // Zoom To Fit All Markers on Google Maps API v3
                    // http://blog.shamess.info/2009/09/29/zoom-to-fit-all-markers-on-google-maps-api-v3/
                    var bounds = new google.maps.LatLngBounds();
                    for (var i = 0, ltLgLen = latLngList.length; i < ltLgLen; i++) {
                        bounds.extend(latLngList[i]);
                    }
                    map.fitBounds(bounds);
                });
                
                // links
                $.getJSON('/json/links', function(links) {
                    $(links).each(function() {
                        var link = this;
                        var start = geocode[link.start]
                        var end = geocode[link.end]
                        var latOffset = 1;
                        var lngOffset = 0;

                        if (link.id == 1) {
                            // UCLA to SALT
                            latOffset = 0.5;
                            lngOffset = -0.5;
                        }
                        else if (link.id == 2) {
                            // SALT to KANS
                            latOffset = 1;
                            lngOffset = 1;
                        }                            
                        else if (link.id == 3) {
                            // SALT to HOUS
                            latOffset = 0.5;
                            lngOffset = 0.5;
                        }                            
                        else if (link.id == 4) {
                            // KANS to HOUS
                            latOffset = 0;
                            lngOffset = -1;
                        }                            
                        else if (link.id == 6) {
                            // KANS to ATLA
                            latOffset = 0;
                            lngOffset = -1;
                        }                            
                        else if (link.id == 7) {
                            // KANS to WASH
                            latOffset = 0.75;
                            lngOffset = 0;
                        }                            
                        else if (link.id == 8) {
                            // ATLA to WASH
                            latOffset = 0.5;
                            lngOffset = -0.5;
                        }                            
                        else if (link.id == 9) {
                            // UCLA to PARC
                            latOffset = 0.5;
                            lngOffset = 0.5;
                        }                            
                        else if (link.id == 10) {
                            // UCLA to UCI
                            latOffset = 0.5;
                            lngOffset = 0.5;
                        }                            
                        else if (link.id == 11) {
                            // UCLA to UCSD
                            latOffset = -1;
                            lngOffset = 0;
                        }                            
                        else if (link.id == 13) {
                            // ATLA to MEMPHIS
                            latOffset = 0;
                            lngOffset = -0.5;
                        }                            
                        else if (link.id == 15) {
                            // KANS to WashU
                            latOffset = 0;
                            lngOffset = 0.5;
                        }                            
                        else if (link.id == 17) {
                            // WASH to NEU
                            latOffset = 0.5;
                            lngOffset = -0.5;
                        }                            
                        else if (link.id == 18) {
                            // UCLA to REMAP
                            latOffset = 0.5;
                            lngOffset = -0.5;
                        }                            
                        else  {
                            // Default
                            latOffset = 1;
                            lngOffset = 0;
                        }                            

                        var linkCoordinates = [
                            new google.maps.LatLng(start.position[0]+.1, start.position[1]),
                            new google.maps.LatLng(end.position[0]+.1, end.position[1]),                        
                        ];
                        var linkCenterCoordinates = new google.maps.LatLng(
                                ((start.position[0] + end.position[0])/2)+latOffset,
                                ((start.position[1] + end.position[1])/2)+lngOffset
                        );
                        
                        var linkPath = new google.maps.Polyline({
                          path: linkCoordinates,
                          strokeColor: linkColorInactive,
                          map: map,
                          strokeOpacity: 0.7,
                          strokeColor: linkColorInactive,
                          strokeWeight: 4
                        });

                        // traffic label
                        var label = new MapLabel({
                            text: '',
                            position: linkCenterCoordinates,
                            map: map,
                            fontSize: 18,
                            align: 'center',
                        });
                        // update link stats periodically
                        $(document).everyTime({{ bw_update_interval }}, function (i) {
                            $.getJSON("{{ bw_url }}"+link.id, function(data) {
                                // update link label
                                rx = data.rx;
                                tx= data.tx;
                                label.set('text', rx.toString() + '/' + tx.toString());
                                // update link color
                                // Some Color choices:
                                // BASICS:
                                // Black:   #000000
                                // Silver:  #C0C0C0
                                // Gray:    #808080
                                // Orange:  #FFA500
                                // Brown:   #A52A2A
                                // Maroon:  #800000
                                // Green:   #008000
                                // Olive:   #808000
                                // Purple:  #800080
                                // Blue:    #0000FF
                                // SlateBlue: #357EC7
                                // DarkBlue: #0000A0
                                // Red:      #FF0000

                                // FANCY:
                                // Purple:  #8E35EF
                                // Magenta: #FF00FF
                                bw = parseFloat(rx) + parseFloat(tx);
                                //if (bw > 1000 ) {
                                //    //  bw > 1000: RED
                                //    linkPath.set('strokeColor', "#FF0000");
                                //    linkPath.set('strokeWeight', "10");
                                //} else if (bw > 500 ) {
                                //    //  bw > 250: RedBrown
                                //    linkPath.set('strokeColor', "#912815");
                                //    linkPath.set('strokeWeight', "8");
                                //} else if (bw > 250 ) {
                                //    //  bw > 250: Purple
                                //    linkPath.set('strokeColor', "#800080");
                                //    linkPath.set('strokeWeight', "6");
                                //} else if (bw > 100) {
                                //    // 100 < bw <= 250: Blue
                                //    linkPath.set('strokeColor', "#225486"); // 4592b7
                                //    linkPath.set('strokeWeight', "4");
                                //} else {
                                //    // 0 < bw <100: Green
                                //    linkPath.set('strokeColor', "#5DA31D");
                                //    linkPath.set('strokeWeight', "2");
                                //}
                                if (bw > 2000 ) {
                                    //  bw > 2000: RED
                                    linkPath.set('strokeColor', "#FF0000");
                                    linkPath.set('strokeWeight', "10");
                                } else if (bw > 1000 ) {
                                    //  bw > 1000: Orange
                                    linkPath.set('strokeColor', "#FFA500");
                                    linkPath.set('strokeWeight', "10");
                                } else if (bw > 500 ) {
                                    //  bw > 250: Dark Blue
                                    linkPath.set('strokeColor', "#0000A0");
                                    linkPath.set('strokeWeight', "8");
                                } else if (bw > 250 ) {
                                    //  bw > 250: Blue
                                    linkPath.set('strokeColor', "#0000FF");
                                    linkPath.set('strokeWeight', "6");
                                } else if (bw > 100) {
                                    // 100 < bw <= 250: Slate Blue
                                    linkPath.set('strokeColor', "#357EC7"); 
                                    linkPath.set('strokeWeight', "4");
                                } else {
                                    // 0 < bw <100: BLACK
                                    linkPath.set('strokeColor', "#000000");
                                    linkPath.set('strokeWeight', "2");
                                }
                            }, "json");
                        }, 0);
                        // infowindow
                        var infowindow = new google.maps.InfoWindow();
                        // Assumptions:
                        //  rx is traffic to link.start
                        //  tx is traffic from link.start; i.e. to link.end                            
                        var contentString = '<div class="info-content">'+
                                             // '<h1>' + start.shortname + ' - ' +
                                             // end.shortname + '</h1>' +
                                            '<p class="rx">To <b>'+ start.shortname + '</b>:</p>' +
                                            '<div id="rx_chart'+ link.id +'" class="link-chart"></div>' +
                                            '<p class="tx">To <b>'+ end.shortname + '</b>:</p>' +
                                            '<div id="tx_chart'+ link.id +'" class="link-chart"></div>';
                        google.maps.event.addListener(linkPath, 'click', function(event) {
                            infowindow.setPosition(event.latLng);
                            infowindow.setContent(contentString);                                             
                            infowindow.open(map); // open before drawing chart
                            $.ajax({
                                url: "{{ spark_rx_url }}"+link.id,
                                success: function(rx_json) {
                                    if (google.visualization &&  google.visualization.DataTable && google.visualization.ImageSparkLine) { 
                                        var rx_data = new google.visualization.DataTable(rx_json); 
                                        var rx_chart = new google.visualization.ImageSparkLine(document.getElementById('rx_chart'+link.id));
                                        rx_chart.draw(rx_data, {width: 190, height: 63, showAxisLines: false,  showValueLabels: true, labelPosition: 'none'});
                                    }
                                }
                            });
                            // // tx (same as above) 
                            // // TODO refactor
                            $.ajax({
                                url: "{{ spark_tx_url }}"+link.id,
                                success: function(tx_json) {
                                    if (google.visualization &&  google.visualization.DataTable && google.visualization.ImageSparkLine) { 
                                        var tx_data = new google.visualization.DataTable(tx_json);
                                        var tx_chart = new google.visualization.ImageSparkLine(document.getElementById('tx_chart'+link.id));
                                        tx_chart.draw(tx_data, {width: 190, height: 63, showAxisLines: false,  showValueLabels: true, labelPosition: 'none'});
                                    }
                                }
                            });
                        });
                    });
                });
                // add hosts
                $.getJSON('/json/hosts/', function(hosts) {
                    $(hosts).each(function() {
                        var host = this;
                        var router = geocode[host.router]
                        lat = host.offset[0] + router.position[0]
                        lng = host.offset[1] + router.position[1]
                        var marker = new google.maps.Marker({
                            position: new google.maps.LatLng(lat, lng),
                            map: map,
                            icon: "{{ STATIC_URL }}img/triangle.png"
                        });
                        var start = router.position
                        var end = [lat, lng]
                        var linkCoordinates = [
                            new google.maps.LatLng(start[0]+.1, start[1]),
                            new google.maps.LatLng(end[0]+.1, end[1]),                        
                        ];
                        var linkPath = new google.maps.Polyline({
                          path: linkCoordinates,
                          strokeColor: "#4592B7",
                          map: map,
                          strokeOpacity: 0.6,
                          strokeWeight: 1
                        });
                    });
                });
            });
            
        }
        </script>
    </head>
    <body onload="initialize()">
        <div id="map_canvas" style="width:100%; height:100%"></div>
    </body>
</html>
